generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Removed Enums: Role, Priority (Replaced by Models)

model Role {
  id          String  @id @default(uuid()) @db.Uuid
  name        String  @unique
  description String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  users       User[]
  permissions RolePermission[]

  @@map("roles")
}

model Module {
  id          String       @id @default(uuid()) @db.Uuid
  name        String       @unique // e.g. User Management
  description String?
  permissions Permission[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("modules")
}

model Permission {
  id          String   @id @default(uuid()) @db.Uuid
  moduleId    String?  @map("module_id") @db.Uuid
  slug        String   @unique // e.g. users:create
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  module Module?          @relation(fields: [moduleId], references: [id])
  roles  RolePermission[]

  @@map("permissions")
}

model RolePermission {
  roleId       String   @map("role_id") @db.Uuid
  permissionId String   @map("permission_id") @db.Uuid
  assignedAt   DateTime @default(now()) @map("assigned_at")

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model Priority {
  id        String    @id @default(uuid()) @db.Uuid
  name      String    @unique
  level     Int // Higher number = Higher priority
  color     String // e.g. #FF0000
  isDefault Boolean   @default(false) @map("is_default")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  tickets Ticket[]

  @@map("priorities")
}

model User {
  id       String  @id @db.Uuid
  email    String  @unique
  fullName String? @map("full_name")
  password String  @default("")

  // RBAC: Replaced Enum with Relation
  roleId String? @map("role_id") @db.Uuid
  role   Role?   @relation(fields: [roleId], references: [id], onDelete: SetNull)

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  ticketsCreated  Ticket[]                  @relation("CreatedBy")
  ticketsAssigned Ticket[]                  @relation("AssignedTo")
  messages        TicketMessage[]
  attachments     TicketMessageAttachment[]
  refreshTokens   RefreshToken[]
  activityLogs    ActivityLog[]
  notifications   Notification[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  token     String   @unique
  userId    String   @map("user_id") @db.Uuid
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  revoked   Boolean  @default(false)

  // Session Management
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  lastActiveAt DateTime @default(now()) @map("last_active_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model Category {
  id          String    @id @default(uuid()) @db.Uuid
  name        String    @unique
  description String?
  createdAt   DateTime  @default(now()) @map("created_at")
  deletedAt   DateTime? @map("deleted_at")
  tickets     Ticket[]

  @@map("categories")
}

model Status {
  id          String    @id @default(uuid()) @db.Uuid
  name        String    @unique
  description String?
  createdAt   DateTime  @default(now()) @map("created_at")
  deletedAt   DateTime? @map("deleted_at")
  tickets     Ticket[]

  @@map("statuses")
}

model Service {
  id          String    @id @default(uuid()) @db.Uuid
  name        String    @unique
  description String?
  createdAt   DateTime  @default(now()) @map("created_at")
  deletedAt   DateTime? @map("deleted_at")
  tickets     Ticket[]

  @@map("services")
}

model Ticket {
  id          String  @id @default(uuid()) @db.Uuid
  title       String
  description String
  categoryId  String  @map("category_id") @db.Uuid
  statusId    String  @map("status_id") @db.Uuid
  serviceId   String? @map("service_id") @db.Uuid

  // Priority: Replaced Enum with Relation
  priorityId String?   @map("priority_id") @db.Uuid
  priority   Priority? @relation(fields: [priorityId], references: [id], onDelete: SetNull)

  assignedTo String?   @map("assigned_to") @db.Uuid
  createdBy  String    @map("created_by") @db.Uuid
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @default(now()) @updatedAt @map("updated_at")
  deletedAt  DateTime? @map("deleted_at")

  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  status   Status   @relation(fields: [statusId], references: [id], onDelete: Cascade)
  service  Service? @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  assignee User?    @relation("AssignedTo", fields: [assignedTo], references: [id], onDelete: SetNull)
  creator  User     @relation("CreatedBy", fields: [createdBy], references: [id], onDelete: Cascade)

  messages     TicketMessage[]
  activityLogs ActivityLog[]

  @@map("tickets")
}

model TicketMessage {
  id        String   @id @default(uuid()) @db.Uuid
  ticketId  String   @map("ticket_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  content   String
  createdAt DateTime @default(now()) @map("created_at")

  ticket      Ticket                    @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user        User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  attachments TicketMessageAttachment[]

  @@map("ticket_messages")
}

model TicketMessageAttachment {
  id         String   @id @default(uuid()) @db.Uuid
  messageId  String?  @map("message_id") @db.Uuid
  fileName   String   @map("file_name")
  fileUrl    String   @map("file_url")
  fileSize   Int      @map("file_size")
  mimeType   String   @map("mime_type")
  uploadedBy String   @map("uploaded_by") @db.Uuid
  uploadedAt DateTime @default(now()) @map("uploaded_at")

  message  TicketMessage? @relation(fields: [messageId], references: [id], onDelete: Cascade)
  uploader User           @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@map("ticket_message_attachments")
}

model ActivityLog {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  ticketId  String?  @map("ticket_id") @db.Uuid
  action    String
  details   String?
  ipAddress String?  @map("ip_address")
  createdAt DateTime @default(now()) @map("created_at")

  // Log Improvements
  metadata  Json?
  severity  String  @default("Info") // Info, Warning, Critical
  userAgent String? @map("user_agent")

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  ticket Ticket? @relation(fields: [ticketId], references: [id], onDelete: SetNull)

  @@map("activity_logs")
}

model Notification {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  title     String
  message   String
  type      String // e.g., "assignment", "message", "status_change"
  isRead    Boolean  @default(false) @map("is_read")
  link      String?
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}
